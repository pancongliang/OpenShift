## Mirroring images for a disconnected installation using the oc-mirror plugin


### Installing the oc-mirror plug-in
* Installing the [oc-mirror plug-in](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#installation-oc-mirror-installing-plugin_installing-mirroring-disconnected)
  ```
  curl -O https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/oc-mirror.tar.gz
  tar -xvf oc-mirror.tar.gz
  chmod +x ./oc-mirror
  sudo mv ./oc-mirror /usr/local/bin/
  ```

### Disabling the default OperatorHub sources
* Disabling the default OperatorHub sources
  ```
  oc patch OperatorHub cluster --type json \
     -p '[{"op": "add", "path": "/spec/disableAllDefaultSources", "value": true}]'
  ```

### Get [operator information](https://cloud.redhat.com/blog/how-oc-mirror-will-help-you-reduce-container-management-complexity)

* Login OperatorHub catalog
  ```
  podman login registry.redhat.io
  ```

* Find the available catalogs for the target version
  ```
  oc-mirror list operators --catalogs --version=4.11
  Available OpenShift OperatorHub catalogs:
  OpenShift 4.11:
  registry.redhat.io/redhat/redhat-operator-index:v4.11
  registry.redhat.io/redhat/certified-operator-index:v4.11
  registry.redhat.io/redhat/community-operator-index:v4.11
  registry.redhat.io/redhat/redhat-marketplace-index:v4.11
  ```

* Find the available packages within the selected catalog
  ```
  oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 > package.out
  cat package.out
  NAME               DISPLAY NAME                                                   DEFAULT CHANNEL
  3scale-operator    Red Hat Integration - 3scale - Managed Application Services    threescale-mas
  ```

* Find channels for the selected package
  ```
  oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 --package=cluster-logging
  NAME             DISPLAY NAME               DEFAULT CHANNEL
  cluster-logging  Red Hat OpenShift Logging  stable

  PACKAGE          CHANNEL     HEAD
  cluster-logging  stable      cluster-logging.5.5.5
  cluster-logging  stable-5.3  cluster-logging.5.3.9
  cluster-logging  stable-5.4  cluster-logging.5.4.9
  cluster-logging  stable-5.5  cluster-logging.5.5.5

  or

  for i in cluster-logging elasticsearch-operator ; do oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 --package=$i; done
  ```

* Find package versions within the selected channel
  ```
  oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 --package=elasticsearch-operator --channel=stable-5.5
  VERSIONS
  5.5.5
  ```

### Configuring [credentials](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#installation-adding-registry-pull-secret_installing-mirroring-disconnected) that allow images to be mirrored

* Download [pull-secret](https://console.redhat.com/openshift/install/pull-secret)

* Add local Image Registry credentials to the pull-secret
  ```
  MIRROR_REGISTRY=docker.registry.example.net:5000
  podman login ${MIRROR_REGISTRY}
  podman login --authfile /root/pull-secret ${MIRROR_REGISTRY}
  ```
  
* Save the file either as ~/.docker/config.json or $XDG_RUNTIME_DIR/containers/auth.json
  ```
  cat /root/pull-secret | jq . > ${XDG_RUNTIME_DIR}/containers/auth.json
  cat ${XDG_RUNTIME_DIR}/containers/auth.json
  {
    "auths": {
      "cloud.openshift.com": {
        "auth": "xxxxxx...",
        "email": "you@example.com"
      },
      "docker.registry.example.net:5000": {
        "auth": "xxxxxx"
   ···
  ```
### Creating the image set configuration

* Creating the [image set configuration](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#oc-mirror-imageset-config-params_installing-mirroring-disconnected)

  Note that when running the oc-mirror plugin again, images are [pruned](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#oc-mirror-updating-registry-about_installing-mirroring-disconnected) automatically from the target mirror registry if they are no longer included in the latest `image set` that was generated and mirrored. 

  ```
  cat > imageset-config.yaml << EOF
  apiVersion: mirror.openshift.io/v1alpha2
  kind: ImageSetConfiguration
  storageConfig:
    local:
      path: metadata     #<-- Specify the metadata path, Do not delete or modify the metadata that is generated by the oc-mirror plug-in.
  mirror:
    operators:
      - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.11   	#<-- Set the Operator catalog
        packages:
          - name: cluster-logging        #<-- Operator name
            channels:                    #<-- Specify channel and version
              - name: stable             #<-- Default Channel
              - name: stable-5.5         #<-- Target Channel - If the expected Channel is different from the Default Channel, need to set the Target Channel after setting the Default Channel
                minVersion: '5.5.5'      #<-- If the first field of the set value is a number, need to add ' '.
                maxVersion: '5.5.5'
          - name: elasticsearch-operator
            channels:
              - name: stable
              - name: stable-5.5
                minVersion: '5.5.5'
                maxVersion: '5.5.5'
          - name: kubernetes-nmstate-operator
            channels:
              - name: stable
              - name: '4.11'
                minVersion: '4.11.0-202212070335'
                maxVersion: '4.11.0-202212070335'
  EOF
  ```
### Mirroring an image set in a fully disconnected environment
* [Mirroring](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#mirroring-image-set-partial) from mirror to disk(online environment)

  ```
  mkdir /root/mirror
  MIRROR_IMAGE_PATH=/root/mirror
  oc mirror --config=./imageset-config.yaml \
            file://${MIRROR_IMAGE_PATH}
  ···
  Creating archive /root/mirror/mirror_seq1_000000.tar
  ```

* Migrate the image set .tar files to a disconnected environment

* Add local Image Registry credentials to the pull-secret(offline environment)
  ```
  OFFLINE_MIRROR_REGISTRY=mirror.registry.example.com:8443
  podman login -u admin ${OFFLINE_MIRROR_REGISTRY}
  podman login -u admin --authfile /root/pull-secret ${OFFLINE_MIRROR_REGISTRY}
  ```

* Save the file either as ~/.docker/config.json or $XDG_RUNTIME_DIR/containers/auth.json (offline environment)
  ```
  cat /root/pull-secret | jq . > ${XDG_RUNTIME_DIR}/containers/auth.json
  ```

* Mirroring from disk to regitry(offline environment)
  ```
  MIRROR_IMAGE_PATH=/root/mirror
  ls ${MIRROR_IMAGE_PATH}
  mirror_seq1_000000.tar  oc-mirror-workspace

  oc mirror --from=${MIRROR_IMAGE_PATH}/mirror_seq1_000000.tar \
            docker://${OFFLINE_MIRROR_REGISTRY} --dest-skip-tls
  ···
  Writing ICSP manifests to oc-mirror-workspace/results-1671769768   #<-- This path is used in subsequent steps to create icsp and catalogsource
  ```


### Create icsp and catalogsource

* Create icsp and catalogsource
  ```
  ls oc-mirror-workspace/results-1671769768
  catalogSource-redhat-operator-index.yaml  charts  imageContentSourcePolicy.yaml  mapping.txt  release-signatures

  oc create -f imageContentSourcePolicy.yaml
  imagecontentsourcepolicy.operator.openshift.io/operator-0 created

  oc create -f catalogSource-redhat-operator-index.yaml
  catalogsource.operators.coreos.com/redhat-operator-index create

  oc-mirror list operators --catalog=${MIRROR_REGISTRY}

  oc get catalogsource -n openshift-marketplace
  NAME                      DISPLAY   TYPE   PUBLISHER   AGE
  redhat-operator-index               grpc               26s

  oc get packagemanifest -n openshift-marketplace
  NAME                               CATALOG   AGE
  cluster-logging                              108s
  elasticsearch-operator                       108s
  kubernetes-nmstate-operator                  108s
  ```
