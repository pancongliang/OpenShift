# Mirror an image set in a full disconnected environment using the oc-mirror plugin


### Installing the oc-mirror plug-in
* Installing the [oc-mirror plug-in](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#installation-oc-mirror-installing-plugin_installing-mirroring-disconnected).
  ```
  curl -O https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/oc-mirror.tar.gz
  tar -xvf oc-mirror.tar.gz
  chmod +x ./oc-mirror
  sudo mv ./oc-mirror /usr/local/bin/
  ```

### Disabling the default OperatorHub sources
* Disabling the default OperatorHub sources
  ```
  oc patch OperatorHub cluster --type json \
     -p '[{"op": "add", "path": "/spec/disableAllDefaultSources", "value": true}]'
  ```

### Get [operator information](https://cloud.redhat.com/blog/how-oc-mirror-will-help-you-reduce-container-management-complexity).

* Login OperatorHub catalog
  ```
  podman login registry.redhat.io
  ```

* Find the available catalogs for the target version
  ```
  oc-mirror list operators --catalogs --version=4.11
  Available OpenShift OperatorHub catalogs:
  OpenShift 4.11:
  registry.redhat.io/redhat/redhat-operator-index:v4.11
  registry.redhat.io/redhat/certified-operator-index:v4.11
  registry.redhat.io/redhat/community-operator-index:v4.11
  registry.redhat.io/redhat/redhat-marketplace-index:v4.11
  ```

* Find the available packages within the selected catalog
  ```
  oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 > package.out
  cat package.out
  NAME               DISPLAY NAME                                                   DEFAULT CHANNEL
  3scale-operator    Red Hat Integration - 3scale - Managed Application Services    threescale-mas
  ```

* Find channels for the selected package
  ```
  oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 --package=cluster-logging
  NAME             DISPLAY NAME               DEFAULT CHANNEL
  cluster-logging  Red Hat OpenShift Logging  stable

  PACKAGE          CHANNEL     HEAD
  cluster-logging  stable      cluster-logging.5.5.5
  cluster-logging  stable-5.3  cluster-logging.5.3.9
  cluster-logging  stable-5.4  cluster-logging.5.4.9
  cluster-logging  stable-5.5  cluster-logging.5.5.5

  or

  for i in cluster-logging elasticsearch-operator ; do oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 --package=$i; done
  ```

* Find package versions within the selected channel
  ```
  oc-mirror list operators --catalog=registry.redhat.io/redhat/redhat-operator-index:v4.11 --package=elasticsearch-operator --channel=stable-5.5
  VERSIONS
  5.5.5
  ```

### [Configuring credentials](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#installation-adding-registry-pull-secret_installing-mirroring-disconnected) that allow images to be mirrored.

* Download pull-secret(https://console.redhat.com/openshift/install/pull-secret)

* Add local Image Registry credentials to the pull-secret
  ```
  MIRROR_REGISTRY=docker.registry.example.net:5000
  podman login ${MIRROR_REGISTRY}
  podman login --authfile /root/pull-secret ${MIRROR_REGISTRY}
  ```
* Save the file either as ~/.docker/config.json or $XDG_RUNTIME_DIR/containers/auth.json
  ```
  cat /root/pull-secret | jq . > ${XDG_RUNTIME_DIR}/containers/auth.json
  cat ${XDG_RUNTIME_DIR}/containers/auth.json
  {
    "auths": {
      "cloud.openshift.com": {
        "auth": "xxxxxx...",
        "email": "you@example.com"
      },
      "docker.registry.example.net:5000": {
        "auth": "xxxxxx"
   ···
  ```

* Creating the [image set configuration](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#oc-mirror-imageset-config-params_installing-mirroring-disconnected)

  Note that when running the oc-mirror plugin again, images are [pruned](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#oc-mirror-updating-registry-about_installing-mirroring-disconnected) automatically from the target mirror registry if they are no longer included in the latest `image set` that was generated and mirrored. 

  ```
  cat > imageset-config.yaml << EOF
  apiVersion: mirror.openshift.io/v1alpha2
  kind: ImageSetConfiguration
  storageConfig:
   registry:                 
     imageURL: ${MIRROR_REGISTRY}/mirror/metadata    #<-- Do not delete or modify metadata generated by the oc-mirror plugin, use the same storage backend every time run the oc-mirror plugin for the same mirror registry.
     skipTLS: false
  mirror:
    operators:
      - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.11   	#<-- Set the Operator catalog
        packages:
          - name: cluster-logging        #<-- Operator name
            channels:                    #<-- Specify channel and version
              - name: stable             #<-- Default Channel
              - name: stable-5.5         #<-- Target Channel - If the expected Channel is different from the Default Channel, need to set the Target Channel after setting the Default Channel
                minVersion: '5.5.5'      #<-- If the first field of the set value is a number, need to add ' '.
                maxVersion: '5.5.5'
          - name: elasticsearch-operator
            channels:
              - name: stable
              - name: stable-5.5
                minVersion: '5.5.5'
                maxVersion: '5.5.5'
          - name: cincinnati-operator
            channels:
              - name: v1
                minVersion: v5.0.0
                maxVersion: v5.0.0
          - name: kubernetes-nmstate-operator
            channels:
              - name: stable
              - name: '4.11'
                minVersion: '4.11.0-202212070335'
                maxVersion: '4.11.0-202212070335'
  EOF
  ```

* [Mirroring](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#mirroring-image-set-partial) an image set to a mirror registry.
  ```
  oc mirror --config=./imageset-config.yaml \
            docker://${MIRROR_REGISTRY} --dest-skip-tls
  ···
  info: Mirroring completed in 1m57.76s (40.22MB/s)
  Rendering catalog image "docker.registry.example.net:5000/redhat/redhat-operator-index:v4.11" with file-based catalog 
  Writing image mapping to oc-mirror-workspace/results-1670920047/mapping.txt
  Writing CatalogSource manifests to oc-mirror-workspace/results-1670920047
  Writing ICSP manifests to oc-mirror-workspace/results-1670920047     #<-- This path is used in subsequent steps to create icsp and catalogsource
  ```

* Create icsp and catalogsource
  ```
  ls oc-mirror-workspace/results-1670920047
  catalogSource-redhat-operator-index.yaml  charts  imageContentSourcePolicy.yaml  mapping.txt  release-signatures

  oc create -f imageContentSourcePolicy.yaml
  imagecontentsourcepolicy.operator.openshift.io/operator-0 created

  oc create -f catalogSource-redhat-operator-index.yaml
  catalogsource.operators.coreos.com/redhat-operator-index create
  ```

* Verify that the operator download is complete
  ```
  oc get catalogsource -n openshift-marketplace
  NAME                      DISPLAY   TYPE   PUBLISHER   AGE
  redhat-operator-index               grpc               13s

  oc get packagemanifest -n openshift-marketplace
  NAME                               CATALOG   AGE
  cluster-logging                              33s
  cincinnati-operator                          33s
  elasticsearch-operator                       33s
  kubernetes-nmstate-operator                  33s
  ```

### Mirroring an image set in a fully disconnected environment
* If it is a completely disconnected environment, `storageConfig.local.path` needs to be set instead of `storageConfig.registry.imageURL` to [mirror the image set to disk with the metadata, then mirror the image set file on disk to a mirror](https://docs.openshift.com/container-platform/4.11/installing/disconnected_install/installing-mirroring-disconnected.html#mirroring-image-set-full).
  ```
  apiVersion: mirror.openshift.io/v1alpha2
  kind: ImageSetConfiguration
  storageConfig:
   registry:                 
     imageURL: ${MIRROR_REGISTRY}/mirror/metadata
  ```
* Change to
  ```
  apiVersion: mirror.openshift.io/v1alpha2
  kind: ImageSetConfiguration
  storageConfig:
    local:
      path: /home/user/metadata   #<-- Do not delete or modify metadata generated by the oc-mirror plugin, use the same storage backend every time run the oc-mirror plugin for the same mirror registry.
  ```
